> 计数排行场景。

> [!NOTE]
>
> 在 `Redis `中存储「点赞数」「浏览数」这类计数数据时，**通常推荐使用单独的 Key（独立键）存储**，而不是将它们嵌入到实体的 Hash 或 `JSON `结构中,**独立 Key 仍是更通用、更安全的选择**。

## 1.原理

**高性能原子操作**
 `Redis `的 `INCR`、`INCRBY`、`DECR` 等命令是**原子的**，天然适合计数场景。

```java
    public void addArticleViewCount(String articleId) {
        String key = "article:" + articleId+":likeCount";
        redisTemplate.opsForValue().increment(key);
    }
```

## 2.依赖引入

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <dependency>
            <groupId>org.redisson</groupId>
            <artifactId>redisson-spring-boot-starter</artifactId>
            <version>3.15.6</version>
        </dependency>
```

## 3.配置文件和Template配置

```yml
server:
  port: 9002

spring:
  redis:
    host: localhost
    port: 6379
    password: redis


```

```java
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // 使用 JSON 序列化
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);

        // 使用 Fastjson 序列化
//        FastJsonRedisSerializer<Object> serializer = new FastJsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        // 设置属性可见性
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        // 设置类型信息
        objectMapper.activateDefaultTyping(
                LaissezFaireSubTypeValidator.instance ,
                ObjectMapper.DefaultTyping.NON_FINAL,
                JsonTypeInfo.As.WRAPPER_ARRAY);

        serializer.setObjectMapper(objectMapper);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        // 初始化
        template.afterPropertiesSet();
        return template;
    }
}
```

## 4. 服务实现

```java
@Service
public class ArticleService {


    @Resource
    private RedisTemplate redisTemplate;


    public void addArticleViewCount(String articleId) {
        String key = "article:" + articleId+":likeCount";
        redisTemplate.opsForValue().increment(key);
    }


    public List<Article> getTopLikedArticles(int topN) {
        // 获取topN个点赞数最多的文章
        Set<String> articleIds = redisTemplate.keys("article:*:likeCount");
        List<Article> topArticles = new ArrayList<>();
        for (String id : articleIds) {
            int likeCount = (Integer) redisTemplate.opsForValue().get(id);
            Article article = new Article();
            article.setId(id.replace("article:", "").replace(":likeCount", ""));
            article.setTitle("文章标题待查询");
            article.setLikeCount(likeCount);
            topArticles.add(article);
        }
        // 根据点赞数排序
        topArticles.sort((a1, a2) -> a2.getLikeCount() - a1.getLikeCount());
        return topArticles.subList(0, topN);
    }



}

```

## 5.控制器

```java
@RestController
public class ArticleController {

    @Resource
    private ArticleService articleService;

    @RequestMapping("/addArticleViewCount")
    public ResponseEntity<String> addArticleViewCount(String articleId) {
        // 添加文章浏览量
        articleService.addArticleViewCount(articleId);
        return ResponseEntity.ok("添加文章浏览量成功");
    }

    @RequestMapping("/getTopLikedArticles")
    public ResponseEntity<List<Article>> getTopLikedArticles(int topN) {
        List<Article> topArticles = articleService.getTopLikedArticles(topN);
        return ResponseEntity.ok(topArticles);
    }
}
```

## 输出

[Apipost-基于协作, 不止于API文档、调试、Mock、自动化测试](https://docs.apipost.net/docs/detail/54662bc6ecca000?locale=zh-cn&target_id=639d80a347003)

> `localhost:9002/addArticleViewCount?articleId=?` 

> `localhost:9002/getTopLikedArticles?topN=2`
>
> ```
> [
> 	{
> 		"id": "202531",
> 		"title": "文章标题待查询",
> 		"likeCount": 158
> 	},
> 	{
> 		"id": "20253121231",
> 		"title": "文章标题待查询",
> 		"likeCount": 110
> 	}
> ]
> ```
>
> 