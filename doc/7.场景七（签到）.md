> 使用Redis的位图（Bitmap）来实现用户签到功能。每个用户用一个bitmap表示，每一天占一个位，偏移量表示第几天

- **极致压缩**：1 亿用户 ≈ 12.5 MB（1 bit/用户）
- **原子操作**：`SETBIT`/`GETBIT` 天然线程安全
- **快速聚合**：`BITCOUNT`、`BITOP` 支持跨天统计

## 服务实现

```java
@Slf4j
@Service
public class UserSignService {

    private final RedisTemplate<String, Object> redisTemplate;

    private static final String GLOBAL_ID_KEY = "global:user:id";
    private static final String ID_MAP_KEY = "user:id:map";      // 原始ID → 整数ID
    private static final String ID_REV_KEY = "user:id:rev";

    // 使用构造器注入
    public UserSignService(RedisTemplate<String, Object> redisTemplate) {
        this.redisTemplate = redisTemplate;
    }


    public boolean sign(String userId){
        LocalDateTime now = LocalDateTime.now();
        String key = buildSignKey(userId, now);
        int dayOfMonth = now.getDayOfMonth();
        // 使用原子操作确保幂等性：先设置再检查之前是否已设置，该方法会返回设置之前的值
        // 如果返回false，表示之前未签到，现在已签到
        // 如果返回true，表示之前已签到
        boolean wasAlreadySigned = Boolean.TRUE.equals(redisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true));
        log.info("用户{}在{}签到，结果：{}", userId, now, !wasAlreadySigned);
        if (wasAlreadySigned) {
            throw new RuntimeException("已经签到过了");
        }
        return true;
    }

    /**
     * 补签
     * @param userId
     * @param signDate
     * @return
     */
    public boolean supplySign(String userId,String signDate){

        // 修复：使用 LocalDate 来解析只包含日期的字符串，然后转换为 LocalDateTime
        LocalDate date = LocalDate.parse(signDate, DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        LocalDateTime dateTime = date.atStartOfDay();

        String key = buildSignKey(userId, dateTime);
        int dayOfMonth = dateTime.getDayOfMonth();
        // 使用原子操作确保幂等性：先设置再检查之前是否已设置，该方法会返回设置之前的值
        // 如果返回false，表示之前未签到，现在已签到
        // 如果返回true，表示之前已签到
        boolean wasAlreadySigned = Boolean.TRUE.equals(redisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true));
        log.info("用户{}在{}签到，结果：{}", userId, dateTime, !wasAlreadySigned);
        if (wasAlreadySigned) {
            throw new RuntimeException("已经签到过了");
        }
        return true;
    }

    public boolean checkSign(String userId){
        LocalDateTime now = LocalDateTime.now();
        String key = buildSignKey(userId, now);
        int dayOfMonth = now.getDayOfMonth();
        return Boolean.TRUE.equals(redisTemplate.opsForValue().getBit(key, dayOfMonth - 1));
    }





    /**
     * 构建签到key
     * @param userId
     * @param now
     * @return
     */
    private String buildSignKey(String userId, LocalDateTime now) {
        String month  = now.format(DateTimeFormatter.ofPattern("yyyyMM"));
        return String.format("user:sign:%s:%s", userId, month);
    }


    /**
     * 获取当月签到次数
     * @param userId 用户ID
     * @param dateStr 查询月份
     * @return 签到次数
     */
    public long getSignCount(String userId, String dateStr) {
        LocalDate date = LocalDate.parse(dateStr, DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        LocalDateTime dateTime = date.atStartOfDay();
        String key = buildSignKey(userId, dateTime);

        // 使用 BITCOUNT 命令统计当月签到次数
        Long count = redisTemplate.execute(
                connection -> connection.bitCount(key.getBytes()),
                true
        );

        return count != null ? count : 0;
    }


}
```

## 控制器

```Java
@RestController
public class SignController {

    @Resource
    private UserSignService userSignService;


    @RequestMapping("/sign")
    public ResponseEntity<?> sign(String userId) {
        try {
            return ResponseEntity.ok(userSignService.sign(userId));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    @RequestMapping("/supplySign")
    public ResponseEntity<?> supplySign(String userId,String signDate) {
        try {
            return ResponseEntity.ok(userSignService.supplySign(userId,signDate));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }

    @RequestMapping("signCount")
    public ResponseEntity<?> signCount(String userId,String signDate) {
        try {
            return ResponseEntity.ok(userSignService.getSignCount(userId,signDate));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(e.getMessage());
        }
    }


}
```

## 请求输出

[Apipost-基于协作, 不止于API文档、调试、Mock、自动化测试](https://docs.apipost.net/docs/detail/54662bc6ecca000?target_id=88d4712f4709e)

## redis 存储形式

![](./assets/image-20251105091922770.png)