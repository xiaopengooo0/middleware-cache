

## docker启动

```yml
services:
  redis:
      image: redis:7.0-alpine
      command: redis-server --requirepass redis
      ports:
        - "6379:6379"
      volumes:
        - E:\docker\data\redis:/data
```

## RedisTemplate 配置

```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // 使用 JSON 序列化
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        // 设置属性可见性
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        // 设置类型信息
        objectMapper.activateDefaultTyping(
                LaissezFaireSubTypeValidator.instance ,
                ObjectMapper.DefaultTyping.NON_FINAL,
                JsonTypeInfo.As.WRAPPER_ARRAY);
        serializer.setObjectMapper(objectMapper);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        template.afterPropertiesSet();
        return template;
    }
}
```

> [!NOTE]
>
> 也可以使用fastjson进行序列化，以及进行序列化配置
>
> ```java
> FastJsonRedisSerializer fastJsonRedisSerializer = new FastJsonRedisSerializer<>(Object.class);
> FastJsonConfig fastJsonConfig = fastJsonRedisSerializer.getFastJsonConfig();
>         SerializeConfig serializeConfig = fastJsonConfig.getSerializeConfig();
>         //加入的locadatetime序列化，也可以不加（但是要用@JSONField(format = "yyyy-MM-dd HH:mm:ss")）格式化
>         serializeConfig.put(LocalDateTime.class, (serializer, object, fieldName, fieldType, features) -> {
>             SerializeWriter out = serializer.out;
>             if (object == null) {
>                 out.writeNull();
>                 return;
>             }
>             out.writeString(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss").format((LocalDateTime) object));
>         });
>         serializeConfig.put(LocalDate.class, (serializer, object, fieldName, fieldType, features) -> {
>             SerializeWriter out = serializer.out;
>             if (object == null) {
>                 out.writeNull();
>                 return;
>             }
>             out.writeString(DateTimeFormatter.ofPattern("yyyy-MM-dd").format((LocalDate) object));
>         });
>         serializeConfig.put(LocalTime.class, (serializer, object, fieldName, fieldType, features) -> {
>             SerializeWriter out = serializer.out;
>             if (object == null) {
>                 out.writeNull();
>                 return;
>             }
>             out.writeString(DateTimeFormatter.ofPattern("HH:mm:ss").format((LocalTime) object));
>         });
>         fastJsonConfig.setSerializeConfig(serializeConfig);
>         fastJsonConfig.setFeatures(Feature.SupportAutoType);
>         fastJsonConfig.setSerializerFeatures(SerializerFeature.WriteClassName);
> 
> ```

## 服务实现

```java
@Service
public class BookServiceImpl implements IBookService {

    private static final Map<Integer, Book> bookMap = Map.of(
            1, new Book(1, "《SpringBoot 1.0开发指南》", "小王"),
            2, new Book(2, "《SpringBoot 2.0开发指南》", "小王"),
            3, new Book(3, "《SpringBoot 3.0开发指南》", "小王"),
            4, new Book(4, "《SpringBoot 4.0开发指南》", "小王")
    );
    private static final Logger log = LoggerFactory.getLogger(BookServiceImpl.class);


    @Resource
    private RedisTemplate<String, Book> redisTemplate;


    @Override
    public Book getBookById(Integer id) {

        Book book  = redisTemplate.opsForValue().get("book:" + id);
        if (book != null) {
            log.info("从Redis中获取数据：{}", book);
            return book;
        }
        book = bookMap.get(id);
        if (book != null) {
            log.info("从Map中获取数据：{}", book);
            // 也可以添加过期时间
            redisTemplate.opsForValue().set("book:" + id, book);
            return book;
        }

        log.info("数据不存在，返回null");

        return book;
    }
}
```

## 测试

```java
@SpringBootTest
@RunWith(SpringRunner.class)
public class CommonApiTest {


    @Resource
    private IBookService bookService;


    @Test
    public void testGetBookById() {
        for (int i = 1; i <= 10; i++) {
             bookService.getBookById(i%5);
        }
    }
}
```

## 输出

```shell
2025-11-03 11:44:19.037  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Map中获取数据：Book(id=1, title=《SpringBoot 1.0开发指南》, author=小王), 并添加缓存
2025-11-03 11:44:19.072  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Map中获取数据：Book(id=2, title=《SpringBoot 2.0开发指南》, author=小王), 并添加缓存
2025-11-03 11:44:19.075  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Map中获取数据：Book(id=3, title=《SpringBoot 3.0开发指南》, author=小王), 并添加缓存
2025-11-03 11:44:19.083  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Map中获取数据：Book(id=4, title=《SpringBoot 4.0开发指南》, author=小王), 并添加缓存
2025-11-03 11:44:19.085  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 数据不存在，返回null
2025-11-03 11:44:19.103  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Redis中获取数据：Book(id=1, title=《SpringBoot 1.0开发指南》, author=小王)
2025-11-03 11:44:19.105  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Redis中获取数据：Book(id=2, title=《SpringBoot 2.0开发指南》, author=小王)
2025-11-03 11:44:19.107  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Redis中获取数据：Book(id=3, title=《SpringBoot 3.0开发指南》, author=小王)
2025-11-03 11:44:19.108  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 从Redis中获取数据：Book(id=4, title=《SpringBoot 4.0开发指南》, author=小王)
2025-11-03 11:44:19.110  INFO 33420 --- [           main] c.s.r.e.c.service.impl.BookServiceImpl   : 数据不存在，返回null

```

## Redis 存储情况

![image-20251103114818644](E:\document\中间件\缓存\assets\image-20251103114818644.png)