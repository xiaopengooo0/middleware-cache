> 主要由`ZSet`实现的积分排序，来存储和排序用户的在线时长，实现一个高效的实时在线时长统计和分析功能

> [!TIP]
>
> 依赖和配置同上

## 服务实现

```java
@Service
public class OnlineDurationService {


    @Resource
    private RedisTemplate redisTemplate;

    @SuppressWarnings("unchecked")
    public void addOnlineUser(String userId) {
        // 记录当前登陆时间
        redisTemplate.opsForValue().set("user:login:" + userId, System.currentTimeMillis());
    }
    @SuppressWarnings("unchecked")
    public void updateOnlineDuration(String userId) {
        long duration = System.currentTimeMillis() - (long)redisTemplate.opsForValue().get("user:login:" + userId);
        redisTemplate.opsForZSet().incrementScore("user:online:duration", userId, duration);
    }

    public Set<UserOnlineDuration> getTopOnlineDuration(int  top) {
        Set<String> set = redisTemplate.opsForZSet().reverseRange("user:online:duration", 0, top - 1);
        HashSet<UserOnlineDuration> userOnlineDurations = new HashSet<>();
        for (String item : set) {
            UserOnlineDuration userOnlineDuration = new UserOnlineDuration();
            Double score = redisTemplate.opsForZSet().score("user:online:duration", item);
            userOnlineDuration.setUserId(item);
            userOnlineDuration.setDuration(score.longValue()/1000);
            userOnlineDurations.add(userOnlineDuration);

        }
        return userOnlineDurations;
    }
}
```

## 控制器

```java
@RestController
public class AnaliseController {

    @Resource
    private OnlineDurationService onlineDurationService;

    @RequestMapping("/user/{userId}/login")
    public ResponseEntity<String> login(@PathVariable String userId) {
        onlineDurationService.addOnlineUser(userId);
        return ResponseEntity.ok("用户" + userId + "登录成功");
    }

    @RequestMapping("/user/{userId}/logout")
    public ResponseEntity<String> logout(@PathVariable String userId) {
        onlineDurationService.updateOnlineDuration(userId);
        return ResponseEntity.ok("用户" + userId + "登出成功");
    }

    @RequestMapping("/top/{top}")
    public ResponseEntity<Set<UserOnlineDuration>> getTopOnlineDuration(@PathVariable int top) {
        return ResponseEntity.ok(onlineDurationService.getTopOnlineDuration(top));
    }
}
```

## 请求输出

[Apipost-基于协作, 不止于API文档、调试、Mock、自动化测试](https://docs.apipost.net/docs/detail/54662bc6ecca000?target_id=74699f4747261)

![image-20251104101916799](.\assets\image-20251104101916799.png)