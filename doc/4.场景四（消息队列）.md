åœ¨ Redis ä¸­ï¼Œ**å‘å¸ƒï¼ˆPublishï¼‰ä¸è®¢é˜…ï¼ˆSubscribeï¼‰** æ˜¯ä¸€ç§**æ¶ˆæ¯ä¼ é€’æ¨¡å¼**ï¼Œå…è®¸å®¢æˆ·ç«¯ä¹‹é—´é€šè¿‡â€œé¢‘é“ï¼ˆchannelï¼‰â€è¿›è¡Œè§£è€¦çš„å®æ—¶é€šä¿¡ã€‚å®ƒéå¸¸é€‚åˆç”¨äºï¼š

- å®æ—¶é€šçŸ¥ï¼ˆå¦‚è®¢å•çŠ¶æ€å˜æ›´ï¼‰
- èŠå¤©ç³»ç»Ÿ
- æœåŠ¡é—´äº‹ä»¶å¹¿æ’­
- ç¼“å­˜å¤±æ•ˆé€šçŸ¥

> [!IMPORTANT]
>
> - Redis **Pub/Sub é€‚åˆè½»é‡çº§ã€å®æ—¶ã€å…è®¸ä¸¢å¤±çš„å¹¿æ’­åœºæ™¯**ï¼›
> - ä½¿ç”¨ `PUBLISH` / `SUBSCRIBE` å‘½ä»¤å³å¯å¿«é€Ÿå®ç°ï¼›
> - åœ¨ Spring Boot ä¸­é€šè¿‡ `RedisMessageListenerContainer` é›†æˆï¼›
> - **ä¸è¦ç”¨äºå…³é”®ä¸šåŠ¡æ¶ˆæ¯**ï¼ˆå¦‚æ”¯ä»˜é€šçŸ¥ï¼‰ï¼Œåº”é€‰æ‹© **Redis Streams** æˆ–ä¸“ä¸š MQã€‚

------

## ğŸ“¡ æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ                     | è¯´æ˜                                             |
| ------------------------ | ------------------------------------------------ |
| **Publisherï¼ˆå‘å¸ƒè€…ï¼‰**  | å‘æŒ‡å®šé¢‘é“å‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯                       |
| **Subscriberï¼ˆè®¢é˜…è€…ï¼‰** | è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ï¼Œæ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯             |
| **Channelï¼ˆé¢‘é“ï¼‰**      | æ¶ˆæ¯çš„ä¼ è¾“é€šé“ï¼Œå¦‚ `news.sports`ã€`order.update` |
| **Patternï¼ˆæ¨¡å¼ï¼‰**      | æ”¯æŒé€šé…ç¬¦è®¢é˜…ï¼ˆå¦‚ `news.*`ï¼‰                    |

> âš ï¸ æ³¨æ„ï¼šRedis çš„ Pub/Sub æ˜¯**fire-and-forgetï¼ˆå³å‘å³å¿˜ï¼‰** æ¨¡å¼ï¼š
>
> - æ¶ˆæ¯**ä¸ä¼šæŒä¹…åŒ–**ï¼ˆè®¢é˜…è€…ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯ä¼šä¸¢å¤±ï¼‰ï¼›
> - **æ²¡æœ‰ ACK æœºåˆ¶**ï¼Œä¸ä¿è¯æ¶ˆæ¯å¯é é€è¾¾ï¼›
> - å¦‚æœéœ€è¦å¯é æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯·è€ƒè™‘ **Redis Streams** æˆ– **RabbitMQ/Kafka**ã€‚

## âœ¨æ ¸å¿ƒé…ç½®

```java
@Configuration
public class RedisPubSubConfig {

    @Bean
    RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory,
                                           MessageListenerAdapter listenerAdapter) {
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        //container.addMessageListener(new MessageListenerImpl(), new PatternTopic("order-update")); 
        container.addMessageListener(listenerAdapter, new PatternTopic("order.update"));
        return container;
    }

    /**
    * ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯è®¢é˜…å¤„ç†ï¼Œä¼šè½¬æ¥åˆ°é…ç½®çš„OrderUpdateSubscriberçš„handleMessageå¤„ç†
    */
    @Bean
    MessageListenerAdapter listenerAdapter(OrderUpdateSubscriber subscriber) {
        return new MessageListenerAdapter(subscriber, "handleMessage");
    }
}

@Component
public class OrderUpdateSubscriber {
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
    }
}
```

> [!TIP]
>
> é‡ç‚¹æ˜¯åœ¨è¿™é‡Œé…ç½®è®¢é˜…æ¶ˆæ¯å¤„ç†ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å®ç°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ç°`MessageListener`ä½¿ç”¨é»˜è®¤è®¾è®¡å®ç°
>
>
> ```
> container.addMessageListener(new MessageListenerImpl(), new PatternTopic("order-channel"));
> ```

## 1.ä¾èµ–å¼•å…¥

## 2. é…ç½®è®¢é˜…ç›‘å¬

>  è®¢é˜…ç»‘å®šï¼Œä¹Ÿå¯ä»¥è®¾ç½®è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†é€»è¾‘

```java
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // ä½¿ç”¨ JSON åºåˆ—åŒ–
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);

        // ä½¿ç”¨ Fastjson åºåˆ—åŒ–
//        FastJsonRedisSerializer<Object> serializer = new FastJsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        // è®¾ç½®å±æ€§å¯è§æ€§
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        // è®¾ç½®ç±»å‹ä¿¡æ¯
        objectMapper.activateDefaultTyping(
                LaissezFaireSubTypeValidator.instance ,
                ObjectMapper.DefaultTyping.NON_FINAL,
                JsonTypeInfo.As.WRAPPER_ARRAY);

        serializer.setObjectMapper(objectMapper);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        // åˆå§‹åŒ–
        template.afterPropertiesSet();
        return template;
    }

    @Bean
    public ReactiveRedisTemplate<String, String> reactiveRedisTemplate(
            ReactiveRedisConnectionFactory connectionFactory) {
        RedisSerializationContext<String, String> serializationContext =
                RedisSerializationContext.<String, String>newSerializationContext()
                        .key(RedisSerializer.string())      // è®¾ç½®keyåºåˆ—åŒ–å™¨
                        .value(RedisSerializer.string())    // è®¾ç½®valueåºåˆ—åŒ–å™¨
                        .hashKey(RedisSerializer.string())  // è®¾ç½®hashKeyåºåˆ—åŒ–å™¨
                        .hashValue(RedisSerializer.string()) // è®¾ç½®hashValueåºåˆ—åŒ–å™¨
                        .build();

        return new ReactiveRedisTemplate<>(connectionFactory, serializationContext);
    }

    @Bean
    public RedisMessageListenerContainer redisMessageListenerContainer(RedisConnectionFactory connectionFactory) {
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        container.addMessageListener(new MessageListenerImpl(), new PatternTopic("order-channel"));
        return container;
    }
}
```

> ç›‘å¬å¤„ç†

```java
@Component
public class MessageListenerImpl implements MessageListener{
    private static final Logger log = LoggerFactory.getLogger(MessageListenerImpl.class);

    @Override
    public void onMessage(Message message, byte[] pattern) {
        byte[] body = message.getBody();
        log.info("ç›‘å¬åˆ°çš„æ¶ˆæ¯ï¼š" + new String(body));
        log.info("ç›‘å¬åˆ°çš„é¢‘é“ï¼š" + new String(message.getChannel()));
        log.info("ç›‘å¬åˆ°çš„æ¨¡å¼ï¼š" + new String(pattern));
        log.info("--------------------------------------------------");

        // å¯ä»¥å°†æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæˆ–è€…å‘é€ç»™å…¶ä»–æœåŠ¡è¿›è¡Œå¤„ç†ï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†ï¼Œå…·ä½“æ ¹æ®ä¸šåŠ¡éœ€æ±‚
        log.info("æ¶ˆæ¯å¤„ç†å®Œæ¯•");
    }
}
```

## 3. æœåŠ¡å®ç°

```java
@Service
public class OrderService {

    @Resource
    private ReactiveRedisTemplate<String, String> reactiveRedisTemplate;

    @Resource
    private RedisTemplate<String, String> redisTemplate;


    public Mono<Void> placeOrder(String orderId) {
        return reactiveRedisTemplate.convertAndSend("order-channel", orderId).then();
    }

    public void sendOrder(String orderId) {
        redisTemplate.convertAndSend("order-channel", orderId);
    }
}
```

> [!IMPORTANT]
>
> > ReactiveRedisTemplate ä¸ RedisTemplate çš„ä¸»è¦åŒºåˆ«
>
> 1. ç¼–ç¨‹æ¨¡å‹
> RedisTemplate: åŸºäºé˜»å¡å¼ I/O çš„åŒæ­¥ç¼–ç¨‹æ¨¡å‹ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°å®Œæˆ
> ReactiveRedisTemplate: åŸºäºå“åº”å¼ç¼–ç¨‹æ¨¡å‹ï¼Œä½¿ç”¨ Reactor æ¡†æ¶ï¼Œæ”¯æŒéé˜»å¡å¼‚æ­¥æ“ä½œ
> 2. è¿”å›ç±»å‹
> RedisTemplate: ç›´æ¥è¿”å›å…·ä½“çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ Stringã€List ç­‰ï¼‰
> ReactiveRedisTemplate: è¿”å› Mono æˆ– Flux å“åº”å¼æµå¯¹è±¡
> 3. æ€§èƒ½ç‰¹ç‚¹
> RedisTemplate: é€‚åˆä¼ ç»ŸåŒæ­¥åº”ç”¨åœºæ™¯ï¼Œç®€å•ç›´è§‚
> ReactiveRedisTemplate: æ›´é«˜çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œé€‚åˆé«˜ååé‡çš„å¼‚æ­¥åœºæ™¯
> 4. ä½¿ç”¨åœºæ™¯
> RedisTemplate: ä¼ ç»Ÿçš„ Spring Boot åº”ç”¨ï¼Œå¯¹å“åº”å¼ç¼–ç¨‹æ— ç‰¹æ®Šè¦æ±‚
> ReactiveRedisTemplate: å“åº”å¼ Web åº”ç”¨ï¼ˆå¦‚ Spring WebFluxï¼‰ï¼Œéœ€è¦éé˜»å¡æ“ä½œçš„åœºæ™¯



## 4.æ§åˆ¶å™¨

```java
@RestController
@RequestMapping("/orders")
public class OrderController {

    @Autowired
    private OrderService orderService;

    @PostMapping
    public Mono<ResponseEntity<Object>> placeOrder(@RequestBody String orderData) {
        return orderService.placeOrder(orderData)
                          .then(Mono.just(ResponseEntity.ok().build()))
                          .defaultIfEmpty(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build());
    }


    @PostMapping("/send")
    public ResponseEntity<Object> sendOrder(@RequestBody String orderData) {
          orderService.sendOrder(orderData);
          return ResponseEntity.ok().build();

    }
}
```



## 5. è¾“å‡º

[Apipost-åŸºäºåä½œ, ä¸æ­¢äºAPIæ–‡æ¡£ã€è°ƒè¯•ã€Mockã€è‡ªåŠ¨åŒ–æµ‹è¯•](https://docs.apipost.net/docs/detail/54662bc6ecca000?locale=zh-cn&target_id=639d80a347003)

> POST `localhost:9003/orders/send` 
>
> ```shell
> 2025-11-03 16:29:33.808  INFO 46348 --- [enerContainer-6] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„æ¶ˆæ¯ï¼š"\"1233456\""
> 2025-11-03 16:29:33.808  INFO 46348 --- [enerContainer-6] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„é¢‘é“ï¼šorder-channel
> 2025-11-03 16:29:33.808  INFO 46348 --- [enerContainer-6] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„æ¨¡å¼ï¼šorder-channel
> 2025-11-03 16:29:33.808  INFO 46348 --- [enerContainer-6] c.s.r.e.m.listener.MessageListenerImpl   : --------------------------------------------------
> 2025-11-03 16:29:33.808  INFO 46348 --- [enerContainer-6] c.s.r.e.m.listener.MessageListenerImpl   : æ¶ˆæ¯å¤„ç†å®Œæ¯•
> ```

>POST `localhost:9003/orders`
>
>2025-11-03 16:30:34.247  INFO 46348 --- [enerContainer-7] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„æ¶ˆæ¯ï¼š"1233456"
>2025-11-03 16:30:34.247  INFO 46348 --- [enerContainer-7] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„é¢‘é“ï¼šorder-channel
>2025-11-03 16:30:34.247  INFO 46348 --- [enerContainer-7] c.s.r.e.m.listener.MessageListenerImpl   : ç›‘å¬åˆ°çš„æ¨¡å¼ï¼šorder-channel
>2025-11-03 16:30:34.247  INFO 46348 --- [enerContainer-7] c.s.r.e.m.listener.MessageListenerImpl   : --------------------------------------------------
>2025-11-03 16:30:34.247  INFO 46348 --- [enerContainer-7] c.s.r.e.m.listener.MessageListenerImpl   : æ¶ˆæ¯å¤„ç†å®Œæ¯•